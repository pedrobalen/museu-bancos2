<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Museu Treze de Maio - Gest√£o de Acervo</title>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --bg: #f4f7f6; --card-bg: #fff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; }
        
        header { background: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { font-size: 1.5rem; margin: 0; }
        
        .admin-link { background: rgba(255,255,255,0.1); color: white; text-decoration: none; padding: 8px 15px; border-radius: 4px; font-size: 0.9rem; transition: 0.2s; border: 1px solid transparent; }
        .admin-link:hover { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); }

        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        
        .tabs { display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid #ddd; }
        .tab-btn { background: none; border: none; font-size: 1.1rem; padding: 0.8rem 1.5rem; cursor: pointer; color: #666; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--accent); }
        
        .toolbar { display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 1.5rem; }
        .search-box { flex: 1; }
        .search-box input { width: 100%; padding: 12px 20px; border-radius: 25px; border: 1px solid #ccc; font-size: 1rem; }

        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-primary { background: var(--accent); }
        .btn-danger { background: #e74c3c; padding: 6px 12px; font-size: 0.85rem; }
        .btn-edit { background: #3498db; padding: 6px 12px; font-size: 0.85rem; margin-right: 5px; }
        .btn-view { background: #2c3e50; padding: 6px 12px; font-size: 0.85rem; margin-right: 5px; }
        .btn-sec { background: #95a5a6; color: white; margin-right: 10px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .card { background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; }
        
        .card-header { background: #34495e; color: white; padding: 0.8rem; font-size: 0.9rem; text-transform: uppercase; display: flex; justify-content: space-between; }
        .card-body { padding: 1.5rem; flex: 1; }
        .card-title { margin: 0 0 0.5rem 0; color: var(--primary); font-size: 1.25rem; }
        .card-text { font-size: 0.9rem; color: #555; margin-bottom: 0.5rem; }
        .card-actions { padding: 1rem; background: #f8f9fa; border-top: 1px solid #eee; text-align: right; }
        .badge { background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
        .badge-missing { background: #c0392b; }
        .hidden { display: none; }

        /* Modais */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); overflow-y: auto; }
        .modal-content { background-color: #fff; margin: 5% auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        
        #modalDetalhes .modal-content { max-width: 800px; width: 95%; }
        .detalhes-container { display: flex; gap: 2rem; align-items: flex-start; }
        .detalhes-img-wrapper { flex: 1; text-align: center; background: #f0f0f0; padding: 10px; border-radius: 8px; min-height: 200px; }
        .detalhes-img-wrapper img { max-width: 100%; max-height: 500px; object-fit: contain; }
        .detalhes-info { flex: 1.5; }
        .info-row { margin-bottom: 12px; font-size: 1rem; border-bottom: 1px dashed #eee; padding-bottom: 8px; }

        @media (max-width: 700px) { .detalhes-container { flex-direction: column; } }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .form-row { display: flex; gap: 10px; }
        .modal-footer { text-align: right; margin-top: 20px; }
    </style>
</head>
<body>

    <header>
        <div>
            <h1>üèõÔ∏è Museu Treze de Maio</h1>
            <div style="font-size: 0.8rem; opacity: 0.8">Painel de Gest√£o</div>
        </div>
        <a href="admin.html" class="admin-link">‚öôÔ∏è Cadastros Auxiliares</a>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('livros')">üìö Biblioteca</button>
            <button class="tab-btn" onclick="switchTab('historico')">üìú Acervo Hist√≥rico</button>
        </div>

        <div class="toolbar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Pesquisar..." onkeyup="handleSearch(this.value)">
            </div>
            <button id="btnNew" class="btn btn-primary" onclick="openModal()">+ Novo Livro</button>
        </div>

        <div id="loading" style="text-align: center; color: #666; padding: 2rem;">Carregando dados...</div>

        <div id="livros-container" class="grid"></div>
        <div id="historico-container" class="grid hidden"></div>
    </div>

    <div id="modalLivro" class="modal">
        <div class="modal-content">
            <h2 id="modalLivroTitle">Gerenciar Livro</h2>
            <form id="formLivro">
                <input type="hidden" id="livroId">
                <div class="form-group">
                    <label>T√≠tulo do Livro</label>
                    <input type="text" id="livroTitulo" required>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1">
                        <label>Ano</label>
                        <input type="number" id="livroAno" required>
                    </div>
                    <div class="form-group" style="flex: 1">
                        <label title="Quantidade Total Comprada">Qtd. Total</label>
                        <input type="number" id="livroQtd" value="1" min="1" required>
                    </div>
                    <div class="form-group" style="flex: 1">
                        <label title="M√≠nimo que deve ficar na biblioteca">Reserva</label>
                        <input type="number" id="livroMin" value="1" min="0" required>
                    </div>
                    </div>
                <div class="form-group">
                    <label>Chamada (C√≥d)</label>
                    <input type="text" id="livroChamada" required>
                </div>
                <div class="form-group">
                    <label>URL da Capa</label>
                    <input type="url" id="livroCapa" placeholder="http://...">
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1">
                        <label>Autor</label>
                        <select id="livroAutorId" required><option>...</option></select>
                    </div>
                    <div class="form-group" style="flex: 1">
                        <label>Editora</label>
                        <select id="livroEditoraId" required><option>...</option></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sec" onclick="closeModals()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalHistorico" class="modal">
        <div class="modal-content">
            <h2>Gerenciar Item Hist√≥rico</h2>
            <form id="formHistorico">
                <input type="hidden" id="histId">
                <div class="form-group">
                    <label>T√≠tulo / Identifica√ß√£o</label>
                    <input type="text" id="histTitulo" required>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1">
                        <label>Tipo</label>
                        <select id="histTipo" required>
                            <option value="Carta">Carta</option>
                            <option value="Foto">Foto</option>
                            <option value="Documento">Documento</option>
                            <option value="Objeto">Objeto</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1">
                        <label>Data</label>
                        <input type="date" id="histData">
                    </div>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <textarea id="histDescricao" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1">
                        <label>Doador</label>
                        <select id="histDoadorId"><option value="">An√¥nimo</option></select>
                    </div>
                    <div class="form-group" style="flex: 1; display: flex; align-items: center; margin-top: 25px;">
                        <input type="checkbox" id="histDigitalizado" style="width: auto; margin-right: 10px;">
                        <label for="histDigitalizado" style="margin:0;">Digitalizado?</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Link Arquivo</label>
                    <input type="url" id="histArquivo">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sec" onclick="closeModals()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalDetalhes" class="modal">
        <div class="modal-content">
            <div style="text-align: right;">
                <button type="button" class="btn btn-sec" onclick="document.getElementById('modalDetalhes').style.display='none'" style="padding: 5px 10px;">‚úï Fechar</button>
            </div>
            <div class="detalhes-container">
                <div class="detalhes-img-wrapper">
                    <img id="detalheImg" src="" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                    <div style="display:none; color: #999;">Sem imagem</div>
                </div>
                <div class="detalhes-info">
                    <h2 id="detalheTitulo"></h2>
                    <div id="detalheConteudo"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';
        let currentTab = 'livros';
        let isEditing = false;
        let searchTimeout = null;

        // Armazena dados globais para acesso do Modal de Detalhes
        window.currentData = { livros: [], historico: [] };

        document.addEventListener('DOMContentLoaded', () => {
            loadLivros();
            loadHistorico();
            populateSelects(); 
        });

        async function populateSelects() {
            try {
                const [resAuth, resEdit, resDoad] = await Promise.all([
                    fetch(`${API}/autores`), fetch(`${API}/editoras`), fetch(`${API}/doadores`)
                ]);
                if(resAuth.ok) {
                    const data = await resAuth.json();
                    document.getElementById('livroAutorId').innerHTML = '<option value="">Selecione...</option>' + data.map(a => `<option value="${a.id_autor}">${a.nome_autor}</option>`).join('');
                }
                if(resEdit.ok) {
                    const data = await resEdit.json();
                    document.getElementById('livroEditoraId').innerHTML = '<option value="">Selecione...</option>' + data.map(e => `<option value="${e.id_editora}">${e.nome_editora}</option>`).join('');
                }
                if(resDoad.ok) {
                    const data = await resDoad.json();
                    document.getElementById('histDoadorId').innerHTML = '<option value="">An√¥nimo / Nenhum</option>' + data.map(d => `<option value="${d.id_doador}">${d.nome_doador}</option>`).join('');
                }
            } catch (e) { console.error("Erro selects:", e); }
        }

        function handleSearch(term) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (currentTab === 'livros') loadLivros(term);
                else loadHistorico(term);
            }, 300);
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('searchInput').value = ''; 
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById('livros-container').classList.toggle('hidden', tab !== 'livros');
            document.getElementById('historico-container').classList.toggle('hidden', tab !== 'historico');
            document.getElementById('btnNew').innerText = tab === 'livros' ? '+ Novo Livro' : '+ Novo Item Hist√≥rico';
            if(tab === 'livros') loadLivros(); else loadHistorico();
        }

        async function loadLivros(query = '') {
            try {
                const url = query ? `${API}/livros?q=${encodeURIComponent(query)}` : `${API}/livros`;
                const res = await fetch(url);
                const data = await res.json();
                window.currentData.livros = data; // Salva globalmente

                if (data.length === 0) {
                    document.getElementById('livros-container').innerHTML = `<div class="empty-state">Nada encontrado.</div>`;
                    document.getElementById('loading').style.display = 'none';
                    return;
                }

                document.getElementById('livros-container').innerHTML = data.map(l => {
                    const jsonItem = JSON.stringify(l).replace(/'/g, "&#39;");
                    
                    // estoque
                    const limiteAtingido = l.quantidade_disponivel <= l.quantidade_minima;
                    
                    let statusColor = '#27ae60'; // Verde
                    let statusMsg = 'Dispon√≠vel';
                    if (limiteAtingido) {
                        statusColor = '#e67e22'; // Laranja
                        statusMsg = 'Apenas Reserva';
                    }
                    if (l.quantidade_disponivel === 0) {
                        statusColor = '#c0392b'; // Vermelho
                        statusMsg = 'Esgotado';
                    }

                    return `
                    <div class="card">
                        ${l.url_capa ? `<div style="height: 200px; overflow: hidden; cursor: pointer;" onclick='openDetails(${l.id_livro}, "livro")'><img src="${l.url_capa}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'"></div>` : ''}
                        
                        <div class="card-header">
                            <span>üìñ Livro</span> 
                            <span>${l.ano_publicacao || 'S/D'}</span>
                        </div>
                        
                        <div class="card-body">
                            <h3 class="card-title" style="cursor:pointer;" onclick='openDetails(${l.id_livro}, "livro")'>${l.titulo}</h3>
                            <p class="card-text"><strong>Autor:</strong> ${l.nome_autor || '?'}</p>
                            
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; border-left: 4px solid ${statusColor}">
                                <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:5px;">
                                    <span>Estante: <strong>${l.quantidade_disponivel}</strong> / ${l.quantidade_total}</span>
                                    <span style="color:${statusColor}; font-weight:bold;">${statusMsg}</span>
                                </div>
                                <div style="display:flex; gap:5px; justify-content:flex-end;">
                                    <button class="btn" style="padding: 2px 10px; background: #e74c3c; color: white;" 
                                            title="Emprestar" onclick="movimentarEstoque(${l.id_livro}, 'emprestar')"
                                            ${limiteAtingido ? 'disabled style="opacity:0.5; cursor:not-allowed; background:#999;"' : ''}>
                                            SA√çDA (-)
                                    </button>
                                    <button class="btn" style="padding: 2px 10px; background: #27ae60; color: white;" 
                                            title="Devolver" onclick="movimentarEstoque(${l.id_livro}, 'devolver')">
                                            RETORNO (+)
                                    </button>
                                </div>
                                <div style="font-size:0.7rem; color:#999; margin-top:5px; text-align:right;">Reserva T√©cnica: ${l.quantidade_minima}</div>
                            </div>

                            <p class="card-text" style="color:#7f8c8d; font-size:0.8rem">Cod: ${l.chamada}</p>
                        </div>
                        
                        <div class="card-actions">
                            <button class="btn btn-view" onclick='openDetails(${l.id_livro}, "livro")'>Ver</button>
                            <button class="btn btn-edit" onclick='openEditLivro(${l.id_livro})'>Editar</button>
                            <button class="btn btn-danger" onclick="deleteItem('livros', ${l.id_livro})">Excluir</button>
                        </div>
                    </div>
                    `;
                }).join('');
                document.getElementById('loading').style.display = 'none';
            } catch (e) { document.getElementById('loading').innerText = 'Erro conex√£o'; }
        }

        async function movimentarEstoque(id, acao) {
            try {
                const res = await fetch(`${API}/livros/${id}/${acao}`, { method: 'PATCH' });
                if (res.ok) {
                    loadLivros(document.getElementById('searchInput').value);
                } else {
                    const err = await res.json();
                    alert(err.error || 'Erro ao atualizar estoque');
                }
            } catch (e) { console.error(e); alert('Erro de conex√£o'); }
        }

        async function loadHistorico(query = '') {
            try {
                const url = query ? `${API}/historico?q=${encodeURIComponent(query)}` : `${API}/historico`;
                const res = await fetch(url);
                const data = await res.json();
                window.currentData.historico = data; // Salva globalmente

                if (data.length === 0) {
                    document.getElementById('historico-container').innerHTML = `<div class="empty-state">Nada encontrado.</div>`;
                    return;
                }
                document.getElementById('historico-container').innerHTML = data.map(h => {
                    return `
                    <div class="card">
                        <div class="card-header" style="background: #2c3e50;">
                            <span>üìú ${h.tipo_item}</span>
                            ${h.foi_digitalizado ? '<span class="badge">Digitalizado</span>' : '<span class="badge badge-missing">F√≠sico</span>'}
                        </div>
                        ${h.caminho_arquivo ? `<div style="padding: 10px; text-align: center; cursor: pointer;" onclick='openDetails(${h.id_item}, "historico")'><img src="${h.caminho_arquivo}" style="max-width: 100%; max-height: 200px; border-radius: 4px;" onerror="this.style.display='none'"></div>` : ''}
                        <div class="card-body">
                            <h3 class="card-title" style="cursor:pointer;" onclick='openDetails(${h.id_item}, "historico")'>${h.titulo}</h3>
                            <p class="card-text">${h.descricao ? h.descricao.substring(0, 100) + '...' : ''}</p>
                            <p class="card-text"><strong>Data:</strong> ${h.data_item ? new Date(h.data_item).toLocaleDateString() : 'S/D'}</p>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-view" onclick='openDetails(${h.id_item}, "historico")'>Ver</button>
                            <button class="btn btn-edit" onclick='openEditHistorico(${h.id_item})'>Editar</button>
                            <button class="btn btn-danger" onclick="deleteItem('historico', ${h.id_item})">Excluir</button>
                        </div>
                    </div>
                    `;
                }).join('');
            } catch (e) { console.error(e); }
        }

        function openDetails(id, type) {
            // Busca o item no array global usando o ID
            const list = type === 'livro' ? window.currentData.livros : window.currentData.historico;
            const item = list.find(i => (type === 'livro' ? i.id_livro : i.id_item) === id);

            if(!item) return;

            const imgEl = document.getElementById('detalheImg');
            const tituloEl = document.getElementById('detalheTitulo');
            const conteudoEl = document.getElementById('detalheConteudo');
            
            const imgUrl = (type === 'livro') ? item.url_capa : item.caminho_arquivo;
            
            imgEl.style.display = 'block';
            if(imgEl.nextElementSibling) imgEl.nextElementSibling.style.display = 'none';

            if (imgUrl) imgEl.src = imgUrl;
            else {
                imgEl.style.display = 'none';
                imgEl.nextElementSibling.style.display = 'flex'; 
                imgEl.nextElementSibling.style.height = '200px';
                imgEl.nextElementSibling.style.alignItems = 'center';
                imgEl.nextElementSibling.style.justifyContent = 'center';
            }

            tituloEl.innerText = item.titulo;
            let html = '';

            if (type === 'livro') {
                html += `<div class="info-row"><strong>Chamada:</strong> ${item.chamada || '-'}</div>`;
                html += `<div class="info-row"><strong>Autor:</strong> ${item.nome_autor || 'Desconhecido'}</div>`;
                html += `<div class="info-row"><strong>Editora:</strong> ${item.nome_editora || 'Desconhecida'}</div>`;
                html += `<div class="info-row"><strong>Ano:</strong> ${item.ano_publicacao || '-'}</div>`;
                html += `<div class="info-row"><strong>Estoque Total:</strong> ${item.quantidade_total}</div>`;
                html += `<div class="info-row"><strong>Dispon√≠vel:</strong> ${item.quantidade_disponivel}</div>`;
                html += `<div class="info-row"><strong>Reserva T√©cnica:</strong> ${item.quantidade_minima} (N√£o circula)</div>`;
            } else {
                const dataFormatada = item.data_item ? new Date(item.data_item).toLocaleDateString() : 'N√£o informada';
                html += `<div class="info-row"><strong>Tipo:</strong> ${item.tipo_item}</div>`;
                html += `<div class="info-row"><strong>Data:</strong> ${dataFormatada}</div>`;
                html += `<div class="info-row"><strong>Doador:</strong> ${item.nome_doador || 'An√¥nimo'}</div>`;
                if (item.descricao) {
                    html += `<div class="info-row" style="border:none; margin-top: 15px;"><strong>Descri√ß√£o Completa:</strong><br><p style="margin-top:5px; color:#555;">${item.descricao}</p></div>`;
                }
                if (item.caminho_arquivo) {
                    html += `<div style="margin-top: 20px;"><a href="${item.caminho_arquivo}" target="_blank" class="btn btn-primary" style="text-decoration:none;">Abrir Arquivo Original ‚Üó</a></div>`;
                }
            }
            conteudoEl.innerHTML = html;
            document.getElementById('modalDetalhes').style.display = 'block';
        }

        // --- FORMS ---
        document.getElementById('formLivro').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('livroId').value;
            const body = {
                titulo: document.getElementById('livroTitulo').value,
                ano_publicacao: document.getElementById('livroAno').value,
                chamada: document.getElementById('livroChamada').value,
                url_capa: document.getElementById('livroCapa').value,
                quantidade_total: document.getElementById('livroQtd').value,
                quantidade_minima: document.getElementById('livroMin').value,
                id_autor: document.getElementById('livroAutorId').value,
                id_editora: document.getElementById('livroEditoraId').value
            };
            await sendData('livros', body, id);
        };

        document.getElementById('formHistorico').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('histId').value;
            const body = {
                titulo: document.getElementById('histTitulo').value,
                tipo_item: document.getElementById('histTipo').value,
                data_item: document.getElementById('histData').value,
                descricao: document.getElementById('histDescricao').value,
                id_doador: document.getElementById('histDoadorId').value || null,
                foi_digitalizado: document.getElementById('histDigitalizado').checked,
                caminho_arquivo: document.getElementById('histArquivo').value
            };
            await sendData('historico', body, id);
        };

        async function sendData(entity, body, id) {
            const method = isEditing ? 'PUT' : 'POST';
            const url = isEditing ? `${API}/${entity}/${id}` : `${API}/${entity}`;
            try {
                const res = await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
                if(res.ok) { closeModals(); if(entity === 'livros') loadLivros(); else loadHistorico(); } 
                else alert('Erro ao salvar.');
            } catch (e) { console.error(e); }
        }

        async function deleteItem(entity, id) {
            if(!confirm('Tem certeza?')) return;
            try {
                const res = await fetch(`${API}/${entity}/${id}`, { method: 'DELETE' });
                if(res.ok) { if(entity === 'livros') loadLivros(); else loadHistorico(); }
                else alert('Erro ao excluir.');
            } catch(e) { console.error(e); }
        }

        function openModal() {
            isEditing = false;
            if(currentTab === 'livros') {
                document.getElementById('formLivro').reset();
                // Reset defaults
                document.getElementById('livroQtd').value = 1;
                document.getElementById('livroMin').value = 1;
                populateSelects(); 
                document.getElementById('modalLivroTitle').innerText = 'Novo Livro';
                document.getElementById('modalLivro').style.display = 'block';
            } else {
                document.getElementById('formHistorico').reset();
                populateSelects(); 
                document.getElementById('modalHistTitle').innerText = 'Novo Item Hist√≥rico';
                document.getElementById('modalHistorico').style.display = 'block';
            }
        }

        function openEditLivro(id) {
            isEditing = true;
            const item = window.currentData.livros.find(i => i.id_livro === id);
            if(!item) return;

            populateSelects().then(() => {
                document.getElementById('livroId').value = item.id_livro;
                document.getElementById('livroTitulo').value = item.titulo;
                document.getElementById('livroAno').value = item.ano_publicacao;
                document.getElementById('livroChamada').value = item.chamada;
                document.getElementById('livroCapa').value = item.url_capa || '';
                document.getElementById('livroQtd').value = item.quantidade_total;
                document.getElementById('livroMin').value = item.quantidade_minima;
                document.getElementById('livroAutorId').value = item.id_autor;
                document.getElementById('livroEditoraId').value = item.id_editora;
                document.getElementById('modalLivroTitle').innerText = 'Editar Livro';
                document.getElementById('modalLivro').style.display = 'block';
            });
        }
        function openEditHistorico(id) {
            isEditing = true;
            const item = window.currentData.historico.find(i => i.id_item === id);
            if(!item) return;

            populateSelects().then(() => {
                document.getElementById('histId').value = item.id_item;
                document.getElementById('histTitulo').value = item.titulo;
                document.getElementById('histTipo').value = item.tipo_item;
                if(item.data_item) document.getElementById('histData').value = item.data_item.split('T')[0];
                document.getElementById('histDescricao').value = item.descricao;
                document.getElementById('histDoadorId').value = item.id_doador;
                document.getElementById('histDigitalizado').checked = item.foi_digitalizado;
                document.getElementById('histArquivo').value = item.caminho_arquivo || '';
                document.getElementById('modalHistTitle').innerText = 'Editar Item Hist√≥rico';
                document.getElementById('modalHistorico').style.display = 'block';
            });
        }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        window.onclick = function(event) { if (event.target.classList.contains('modal')) closeModals(); }
    </script>
</body>
</html>